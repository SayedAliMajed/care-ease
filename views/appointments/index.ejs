<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Appointments</title>
   <link rel="stylesheet" href="/stylesheets/style.css">
</head>
<body>
  <%- include('../partials/_navbar.ejs') %>
  
  <main>
    <h1>Appointments</h1>

    <!-- Filters -->
    <form method="GET" action="/appointments">
      <div>
        <% if (user.role === 'employee' || user.role === 'admin') { %>
          <div>
            <label for="doctor_Id">Doctor:</label>
            <select name="doctor_Id" id="doctor_Id">
              <option value="">All Doctors</option>
              <% doctors.forEach(function(doctor) { %>
                <option value="<%= doctor._id %>" 
                  <%= filters.doctor_Id === doctor._id.toString() ? 'selected' : '' %>>
                  <%= doctor.profile.fullName %>
                </option>
              <% }); %>
            </select>
          </div>
        <% } %>

        <div>
          <label for="status">Status:</label>
          <select name="status" id="status">
            <option value="">All Statuses</option>
            <option value="scheduled" <%= filters.status === 'scheduled' ? 'selected' : '' %>>Scheduled</option>
            <option value="completed" <%= filters.status === 'completed' ? 'selected' : '' %>>Completed</option>
            <option value="cancelled" <%= filters.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
          </select>
        </div>

        <div>
          <label for="dateFrom">From:</label>
          <input type="date" id="dateFrom" name="dateFrom" value="<%= filters.dateFrom || '' %>">
        </div>

        <div>
          <label for="dateTo">To:</label>
          <input type="date" id="dateTo" name="dateTo" value="<%= filters.dateTo || '' %>">
        </div>

        <div>
          <button type="submit">Filter</button>
          <a href="/appointments">Clear</a>
        </div>
      </div>
    </form>

    <!-- Appointments Table -->
    <div>
      <table border="1">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Patient</th>
            <th>Doctor</th>
            <th>Status</th>
            <th>Actions</th>
            <th>Prescription</th>
          </tr>
        </thead>
        <tbody>
          <% if (appointments.length === 0) { %>
            <tr>
              <td colspan="7">No appointments found</td>
            </tr>
          <% } else { %>
            <% appointments.forEach(function(appointment) { %>
              <tr>
                <td><%= appointment.date.toDateString() %></td>
                <td><%= appointment.time %></td>
                <td>
                  <%= appointment.patient_id.profile.fullName %>
                  <% if (appointment.patient_id.profile.cpr) { %>
                    <br>CPR: <%= appointment.patient_id.profile.cpr %>
                  <% } %>
                </td>
                <td><%= appointment.doctor_Id.profile.fullName %></td>
                <td><%= appointment.status %></td>
                <td>
                  <div>
                    <% if (user.role === 'admin' || user.role === 'employee') { %>
                      <a href="/appointments/<%= appointment._id %>/edit">Edit</a>
                      <form action="/appointments/<%= appointment._id %>?_method=DELETE" method="POST" style="display: inline;">
                        <button type="submit" onclick="return confirm('Are you sure you want to delete this appointment?')">
                          Delete
                        </button>
                      </form>
                    <% } else if (user.role === 'patient') { %>
                      <a href="/appointments/<%= appointment._id %>/edit">View</a>
                    <% } %>
                  </div>
                </td>
                <td>
                  <% if (appointment.status === 'scheduled' && (user.role === 'doctor' || user.role === 'admin')) { %>
                    <a href="/appointments/<%= appointment._id %>/prescription">Add Prescription</a>
                  <% } else if (appointment.prescription) { %>
                    <strong>Prescribed</strong>
                    <br>
                    <small>
                      <strong>Prescription:</strong><br>
                      <%= appointment.prescription.split('\n').join('<br>') %>
                    </small>
                  <% } else { %>
                    No Prescription
                  <% } %>
                </td>
              </tr>
            <% }); %>
          <% } %>
        </tbody>
      </table>
    </div>

    <!-- New Appointment Button -->
    <% if (user.role === 'admin' || user.role === 'employee' || user.role === 'patient') { %>
      <div>
        <a href="/appointments/new">New Appointment</a>
        
        <% if (user.role === 'admin' || user.role === 'employee') { %>
          <a href="/appointments/search-patients">Search Patients</a>
        <% } %>
      </div>
    <% } %>
  </main>
</body>
</html>